name: Snyk Monitor Scanning
on:
 release:
   types: [published] 
 push:
    branches:
      - 'main' 
 workflow_dispatch:

permissions:
  contents: read

jobs:
  get-token:
    runs-on: ubuntu-latest
    outputs:
      secrets: ${{ steps.get-secrets.outputs.secrets }}
    steps:
      - name: Retrieve API key
        id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@5d7e361bc7e0a183cde8afe9899fb7b596d2659b # get-vault-secrets-v1.2.0
        with:
          common_secrets: |
            SNYK_TOKEN=snyk_scan_github_action:token

  snyk-scan-ci:
    needs: get-token
    uses: 'grafana/security-github-actions/.github/workflows/snyk_monitor.yml@main'
    secrets:
      SNYK_TOKEN: ${{ fromJson(needs.get-token.outputs.secrets).SNYK_TOKEN }}
