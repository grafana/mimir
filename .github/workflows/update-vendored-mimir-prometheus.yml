name: Update mimir-prometheus dependency

on:
  workflow_dispatch:
    inputs:
      mimir_branch:
        description: 'Mimir branch to update'
        required: true
        default: 'main'
        type: string
      mimir_prometheus_branch:
        description: 'mimir-prometheus branch/commit to update to'
        required: true
        default: 'main'
        type: string

  repository_dispatch:
    types: [ mimir-prometheus-branch-push ]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update-mimir-prometheus:
    runs-on: ubuntu-latest
    steps:
      - name: Determine branch names (repository_dispatch)
        id: branch-names-dispatch
        if: github.event_name == 'repository_dispatch'
        env:
          MIMIR_PROMETHEUS_BRANCH: ${{ github.event.client_payload.branch_name }}
        run: |
          # For repository_dispatch, use the env-injected mimir_prometheus_branch.
          # The main use case is for weekly branches, so we just use the same branch name here too.
          echo "Triggered by repository_dispatch"
          echo "Using mimir-prometheus branch from payload: $MIMIR_PROMETHEUS_BRANCH"
          
          echo "mimir_branch=$MIMIR_PROMETHEUS_BRANCH" >> $GITHUB_OUTPUT
          echo "mimir_prometheus_branch=$MIMIR_PROMETHEUS_BRANCH" >> $GITHUB_OUTPUT

      - name: Determine branch names (workflow_dispatch)
        id: branch-names-manual
        if: github.event_name == 'workflow_dispatch'
        env:
          MIMIR_BRANCH: ${{ inputs.mimir_branch }}
          MIMIR_PROMETHEUS_BRANCH: ${{ inputs.mimir_prometheus_branch }}
        run: |
          # For workflow_dispatch, use the env-injected branch names.
          echo "Triggered by workflow_dispatch"
          echo "Using input values - mimir branch: $MIMIR_BRANCH, mimir-prometheus branch: $MIMIR_PROMETHEUS_BRANCH"

          echo "mimir_branch=$MIMIR_BRANCH" >> $GITHUB_OUTPUT
          echo "mimir_prometheus_branch=$MIMIR_PROMETHEUS_BRANCH" >> $GITHUB_OUTPUT

      - name: Determine branch names (combined)
        id: branch-names
        run: |
          echo "mimir_branch=${{ steps.branch-names-dispatch.outputs.mimir_branch || steps.branch-names-manual.outputs.mimir_branch }}" >> $GITHUB_OUTPUT
          echo "mimir_prometheus_branch=${{ steps.branch-names-dispatch.outputs.mimir_prometheus_branch || steps.branch-names-manual.outputs.mimir_prometheus_branch }}" >> $GITHUB_OUTPUT

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch-names.outputs.mimir_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          set-safe-directory: '*'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # We only use this to run `go mod` commands, so it doesn't need to follow the version used in the Dockerfile.
          go-version: "1.25.7"

      # This job uses "mimir-vendoring bot" instead of "github-actions bot" (secrets.GITHUB_TOKEN)
      # because any events triggered by the later don't spawn GitHub actions.
      # Refer to https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow
      - name: Retrieve GitHub App Credentials from Vault
        id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@5d7e361bc7e0a183cde8afe9899fb7b596d2659b # get-vault-secrets-v1.2.0
        with:
          repo_secrets: |
            APP_ID=mimir-vendoring:app-id
            PRIVATE_KEY=mimir-vendoring:app-pem-key

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          # Variables generated by the previous step get-secrets
          app-id: ${{ env.APP_ID }}
          private-key: ${{ env.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get mimir-prometheus commit info
        id: get-commit-info
        env:
          MIMIR_PROMETHEUS_BRANCH: ${{ steps.branch-names.outputs.mimir_prometheus_branch }}
        run: |
          # Fetch the latest commit hash from the specified branch
          NEW_HASH=$(git ls-remote https://github.com/grafana/mimir-prometheus.git "${MIMIR_PROMETHEUS_BRANCH}" | cut -f1)
          if [ -z "$NEW_HASH" ]; then
            echo "Error: Could not find commit hash for branch/ref ${MIMIR_PROMETHEUS_BRANCH}"
            exit 1
          fi
          
          # Get current mimir-prometheus version from go.mod
          OLD_HASH=$(go mod edit -json | jq -r '.Replace[] | select(.New.Path == "github.com/grafana/mimir-prometheus") | .New.Version | .[-12:]')
          if [ -z "OLD_HASH" ] || [ "OLD_HASH" = "null" ]; then
            echo "No current mimir-prometheus version found in go.mod"
            OLD_HASH=""
          fi
          
          
          # Get short commit hash for display
          SHORT_HASH=${NEW_HASH:0:12}
          
          # Create timestamp for branch naming so that multiple runs don't clobber each other
          TIMESTAMP=$(date +%Y%m%d%H%M)
          
          echo "old_hash=$OLD_HASH" >> $GITHUB_OUTPUT
          echo "new_hash=$NEW_HASH" >> $GITHUB_OUTPUT
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Found commit: $NEW_HASH"
          echo "Current mimir-prometheus hash: $CURRENT_VERSION"

      - name: Update go.mod
        run: |
          # Update the replace directive in go.mod using go mod edit with commit hash
          go mod edit -replace=github.com/prometheus/prometheus=github.com/grafana/mimir-prometheus@${{ steps.get-commit-info.outputs.new_hash }}
          
          echo "Updated go.mod with new mimir-prometheus commit: ${{ steps.get-commit-info.outputs.new_hash }}"

      - name: Update dependencies
        run: |
          echo "Tidying go.mod and updating vendor directory..."
          go mod tidy
          go mod vendor
          
          echo "Dependencies updated successfully"

      - name: Create Pull Request
        id: create_pull_request
        uses: peter-evans/create-pull-request@4e1beaa7521e8b457b572c090b25bd3db56bf1c5 # v5.0.3
        with:
          token: ${{ steps.app-token.outputs.token }}
          title: '[${{ steps.branch-names.outputs.mimir_branch }}] Update mimir-prometheus to ${{ steps.get-commit-info.outputs.short_hash }}'
          body: |
            ## Update mimir-prometheus dependency

            *This PR was automatically created by the [update-vendored-mimir-prometheus.yml](https://github.com/grafana/mimir/blob/main/.github/workflows/update-vendored-mimir-prometheus.yml) workflow.*

            ### Details:
            - **Source branch/ref**: ${{ format('[`{0}`](https://github.com/grafana/mimir-prometheus/tree/{0})', steps.branch-names.outputs.mimir_prometheus_branch) }}
            - **Previous commit**: ${{ format('[`{0}`](https://github.com/grafana/mimir-prometheus/commit/{0})', steps.get-commit-info.outputs.old_hash) }}
            - **New commit**: ${{ format('[`{0}`](https://github.com/grafana/mimir-prometheus/commit/{0})', steps.get-commit-info.outputs.new_hash) }}
            - **Changes**: ${{ format('[`{0}...{1}`](https://github.com/grafana/mimir-prometheus/compare/{0}...{1})', steps.get-commit-info.outputs.old_hash, steps.get-commit-info.outputs.new_hash) }}
          commit-message: Update mimir-prometheus to `${{ steps.get-commit-info.outputs.short_hash }}`
          branch: bot/${{ steps.branch-names.outputs.mimir_branch }}/update-mimir-prometheus-${{ steps.get-commit-info.outputs.short_hash }}-${{ steps.get-commit-info.outputs.timestamp }}
          base: ${{ steps.branch-names.outputs.mimir_branch }}
          labels: vendored-mimir-prometheus-update
          delete-branch: true

      - name: Close Old Vendor PRs
        run: |
          prs=$(gh pr list --state open --json number --search 'label:vendored-mimir-prometheus-update' --base $BASE_BRANCH --jq '.[].number')
          echo "The following Mimir automatic vendor PRs are open: $prs"
          for pr in $prs; do
            if [ $pr == ${PULL_REQUEST_NUMBER} ]; then
              continue
            fi
            gh pr comment $pr -b "This pull request has been automatically closed because it has been superseded by #${PULL_REQUEST_NUMBER}."
            gh pr close $pr --delete-branch
          done
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BASE_BRANCH: ${{ steps.branch-names.outputs.mimir_branch }}
          PULL_REQUEST_NUMBER: ${{ steps.create_pull_request.outputs.pull-request-number }}
