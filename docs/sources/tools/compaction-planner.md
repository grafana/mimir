---
title: "Compaction planner"
description: ""
weight: 100
---

# Compaction planner

The compaction planner is a tool for troubleshooting the Grafana Mimir compactor. It loads an object storage 
(f.ex. Google Cloud Storage) bucket index and shows compaction jobs that would be generated by the 
split-and-merge compaction strategy. Because the compaction planner relies on the bucket index to get a list 
of blocks for a tenant, it lacks up-to-date knowledge of the blocks in the bucket. The bucket index gets refreshed
on every run of the compactor, which should execute regularly (for example every 15 minutes).

The compaction planner needs to be configured with the correct blocks bucket (via f.ex. 
`-gcs.bucket-name` CLI flag), and the correct tenant ID (via `-user` CLI flag). Furthermore, the `-shard-count`
and `-split-groups` options should be used to match  corresponding split-and-merge compactor parameters. The 
compaction planner is not able to automatically deduce them itself. The ordering of the jobs can be modified 
through the `-sorting` option.

Example:

```
$ ./compaction-planner -backend=gcs -gcs.bucket-name=blocks-bucket -user=10428 -split-groups=1 -shard-count=4
2022-02-04 09:52:05.506428 I | Using index from 2022-02-04T08:38:27Z
2022-02-04 09:52:05.533720 I | Filtering using *compactor.NoCompactionMarkFilter
Job No.   Start Time             End Time               Blocks   Job Key
1         2022-02-04T02:00:00Z   2022-02-04T04:00:00Z   4        0@6672437747845546250-merge-2_of_4-1643940000000-1643947200000
2         2022-02-04T02:00:00Z   2022-02-04T04:00:00Z   4        0@6672437747845546250-merge-4_of_4-1643940000000-1643947200000
3         2022-02-04T04:00:00Z   2022-02-04T06:00:00Z   4        0@6672437747845546250-merge-1_of_4-1643947200000-1643954400000
4         2022-02-04T04:00:00Z   2022-02-04T06:00:00Z   4        0@6672437747845546250-merge-2_of_4-1643947200000-1643954400000
5         2022-02-04T04:00:00Z   2022-02-04T06:00:00Z   4        0@6672437747845546250-merge-3_of_4-1643947200000-1643954400000
6         2022-02-04T04:00:00Z   2022-02-04T06:00:00Z   4        0@6672437747845546250-merge-4_of_4-1643947200000-1643954400000
```

Each output line is one compaction job that the Grafana Mimir compactor with the same parameters would work on in the specified order.
