services:
  alertmanager-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=alertmanager -server.http-listen-port=18040 -server.grpc-listen-port=19040 -activity-tracker.filepath=/activity/alertmanager-18040 -alertmanager.web.external-url=http://localhost:18040/alertmanager -memberlist.nodename=alertmanager-1 -memberlist.bind-port=20040 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=alertmanager-1"
    hostname: "alertmanager-1"
    image: "mimir"
    ports:
      - "18040:18040"
      - "20040:20040"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  alertmanager-2:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=alertmanager -server.http-listen-port=18041 -server.grpc-listen-port=19041 -activity-tracker.filepath=/activity/alertmanager-18041 -alertmanager.web.external-url=http://localhost:18041/alertmanager -memberlist.nodename=alertmanager-2 -memberlist.bind-port=20041 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=alertmanager-2"
    hostname: "alertmanager-2"
    image: "mimir"
    ports:
      - "18041:18041"
      - "20041:20041"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  compactor-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=compactor -server.http-listen-port=8006 -server.grpc-listen-port=9006 -activity-tracker.filepath=/activity/compactor-8006  -memberlist.nodename=compactor -memberlist.bind-port=10006 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=compactor"
    hostname: "compactor-1"
    image: "mimir"
    ports:
      - "8006:8006"
      - "10006:10006"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  continuous-test:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=continuous-test -server.http-listen-port=8090 -server.grpc-listen-port=9090 -activity-tracker.filepath=/activity/continuous-test-8090  -tests.run-interval=2m -tests.read-endpoint=http://envoy:8080/prometheus -tests.tenant-id=mimir-continuous-test -tests.write-endpoint=http://envoy:8080 -tests.write-read-series-test.max-query-age=1h -tests.write-read-series-test.num-series=100 -memberlist.nodename=continuous-test -memberlist.bind-port=10090 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=continuous-test"
    hostname: "continuous-test"
    image: "mimir"
    ports:
      - "8090:8090"
      - "10090:10090"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  distributor-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=distributor -server.http-listen-port=8000 -server.grpc-listen-port=9000 -activity-tracker.filepath=/activity/distributor-8000  -memberlist.nodename=distributor-1 -memberlist.bind-port=10000 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=distributor-1"
    hostname: "distributor-1"
    image: "mimir"
    ports:
      - "8000:8000"
      - "10000:10000"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  distributor-2:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=distributor -server.http-listen-port=8001 -server.grpc-listen-port=9001 -activity-tracker.filepath=/activity/distributor-8001  -memberlist.nodename=distributor-2 -memberlist.bind-port=10001 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=distributor-2"
    hostname: "distributor-2"
    image: "mimir"
    ports:
      - "8001:8001"
      - "10001:10001"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  envoy:
    image: "envoyproxy/envoy:v1.35-latest"
    ports:
      - "8080:8080"
      - "9901:9901"
    volumes:
      - "./generated/envoy.yaml:/etc/envoy/envoy.yaml"
  grafana:
    environment:
      - "GF_AUTH_ANONYMOUS_ENABLED=true"
      - "GF_AUTH_ANONYMOUS_ORG_ROLE=Admin"
    image: "grafana/grafana:12.1.1"
    ports:
      - "3000:3000"
    volumes:
      - "./generated/datasources.yaml:/etc/grafana/provisioning/datasources/mimir.yaml"
      - "./generated/dashboards-mimir.yaml:/etc/grafana/provisioning/dashboards/mimir.yaml"
      - "../../operations/mimir-mixin-compiled/dashboards:/var/lib/grafana/dashboards/Mimir"
  ingester-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=ingester -server.http-listen-port=8002 -server.grpc-listen-port=9002 -activity-tracker.filepath=/activity/ingester-8002  -memberlist.nodename=ingester-1 -memberlist.bind-port=10002 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=ingester-1"
    hostname: "ingester-1"
    image: "mimir"
    ports:
      - "8002:8002"
      - "10002:10002"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
      - ".data-ingester-1:/tmp/mimir-tsdb-ingester:delegated"
  ingester-2:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=ingester -server.http-listen-port=8003 -server.grpc-listen-port=9003 -activity-tracker.filepath=/activity/ingester-8003  -memberlist.nodename=ingester-2 -memberlist.bind-port=10003 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=ingester-2"
    hostname: "ingester-2"
    image: "mimir"
    ports:
      - "8003:8003"
      - "10003:10003"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
      - ".data-ingester-2:/tmp/mimir-tsdb-ingester:delegated"
  ingester-3:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=ingester -server.http-listen-port=8004 -server.grpc-listen-port=9004 -activity-tracker.filepath=/activity/ingester-8004  -memberlist.nodename=ingester-3 -memberlist.bind-port=10004 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=ingester-3"
    hostname: "ingester-3"
    image: "mimir"
    ports:
      - "8004:8004"
      - "10004:10004"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
      - ".data-ingester-3:/tmp/mimir-tsdb-ingester:delegated"
  jaeger:
    image: "jaegertracing/all-in-one:1.62.0"
    ports:
      - "16686:16686"
      - "14268"
  memcached:
    image: "memcached:1.6.34-alpine"
    ports:
      - "11211:11211"
  memcached-exporter:
    command:
      - "--memcached.address=memcached:11211"
      - "--web.listen-address=0.0.0.0:9150"
    image: "prom/memcached-exporter:v0.15.3"
  minio:
    command:
      - "server"
      - "--console-address"
      - ":9001"
      - "/data"
    environment:
      - "MINIO_ROOT_USER=mimir"
      - "MINIO_ROOT_PASSWORD=supersecret"
    image: "minio/minio:RELEASE.2025-05-24T17-08-30Z"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ".data-minio:/data:delegated"
  prometheus:
    command:
      - "--config.file=/etc/prometheus/prometheus.yaml"
      - "--enable-feature=exemplar-storage"
      - "--enable-feature=native-histograms"
    image: "prom/prometheus:v3.5.0"
    ports:
      - "9090:9090"
    volumes:
      - "./generated:/etc/prometheus"
      - "../../operations/mimir-mixin-compiled/alerts.yaml:/etc/mixin/mimir-alerts.yaml"
      - "../../operations/mimir-mixin-compiled/rules.yaml:/etc/mixin/mimir-rules.yaml"
  prometheus-ha-1:
    command:
      - "--config.file=/etc/prometheus/prometheus-ha-1.yaml"
      - "--enable-feature=exemplar-storage"
      - "--enable-feature=native-histograms"
    image: "prom/prometheus:v3.5.0"
    ports:
      - "9091:9090"
    volumes:
      - "./generated:/etc/prometheus"
  prometheus-ha-2:
    command:
      - "--config.file=/etc/prometheus/prometheus-ha-2.yaml"
      - "--enable-feature=exemplar-storage"
      - "--enable-feature=native-histograms"
    image: "prom/prometheus:v3.5.0"
    ports:
      - "9092:9090"
    volumes:
      - "./generated:/etc/prometheus"
  querier-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=querier -server.http-listen-port=8005 -server.grpc-listen-port=9005 -activity-tracker.filepath=/activity/querier-8005  -memberlist.nodename=querier -memberlist.bind-port=10005 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=querier"
    hostname: "querier-1"
    image: "mimir"
    ports:
      - "8005:8005"
      - "10005:10005"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  query_frontend-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=query-frontend -server.http-listen-port=8007 -server.grpc-listen-port=9007 -activity-tracker.filepath=/activity/query-frontend-8007  -memberlist.nodename=query-frontend -memberlist.bind-port=10007 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=query-frontend"
    hostname: "query_frontend-1"
    image: "mimir"
    ports:
      - "8007:8007"
      - "10007:10007"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  query_scheduler-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=query-scheduler -server.http-listen-port=8008 -server.grpc-listen-port=9008 -activity-tracker.filepath=/activity/query-scheduler-8008  -memberlist.nodename=query-scheduler -memberlist.bind-port=10008 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=query-scheduler"
    hostname: "query_scheduler-1"
    image: "mimir"
    ports:
      - "8008:8008"
      - "10008:10008"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  ruler-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=ruler -server.http-listen-port=8022 -server.grpc-listen-port=9022 -activity-tracker.filepath=/activity/ruler-8022  -memberlist.nodename=ruler-1 -memberlist.bind-port=10022 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=ruler-1"
    hostname: "ruler-1"
    image: "mimir"
    ports:
      - "8022:8022"
      - "10022:10022"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  ruler-2:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=ruler -server.http-listen-port=8023 -server.grpc-listen-port=9023 -activity-tracker.filepath=/activity/ruler-8023  -memberlist.nodename=ruler-2 -memberlist.bind-port=10023 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=ruler-2"
    hostname: "ruler-2"
    image: "mimir"
    ports:
      - "8023:8023"
      - "10023:10023"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  store-gateway-1:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=store-gateway -server.http-listen-port=8011 -server.grpc-listen-port=9011 -activity-tracker.filepath=/activity/store-gateway-8011  -memberlist.nodename=store-gateway-1 -memberlist.bind-port=10011 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=store-gateway-1"
    hostname: "store-gateway-1"
    image: "mimir"
    ports:
      - "8011:8011"
      - "10011:10011"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  store-gateway-2:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=store-gateway -server.http-listen-port=8012 -server.grpc-listen-port=9012 -activity-tracker.filepath=/activity/store-gateway-8012  -memberlist.nodename=store-gateway-2 -memberlist.bind-port=10012 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=store-gateway-2"
    hostname: "store-gateway-2"
    image: "mimir"
    ports:
      - "8012:8012"
      - "10012:10012"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"
  store-gateway-3:
    build:
      context: "."
      dockerfile: "dev.dockerfile"
    command:
      - "sh"
      - "-c"
      - "sleep 3 && exec ./mimir -config.file=./config/mimir.yaml -target=store-gateway -server.http-listen-port=8013 -server.grpc-listen-port=9013 -activity-tracker.filepath=/activity/store-gateway-8013  -memberlist.nodename=store-gateway-3 -memberlist.bind-port=10013 -ingester.ring.store=memberlist -distributor.ring.store=memberlist -compactor.ring.store=memberlist -store-gateway.sharding-ring.store=memberlist -ruler.ring.store=memberlist -alertmanager.sharding-ring.store=memberlist"
    depends_on:
      - "minio"
      - "distributor-1"
    environment:
      - "JAEGER_AGENT_HOST=jaeger"
      - "JAEGER_AGENT_PORT=6831"
      - "JAEGER_SAMPLER_PARAM=1"
      - "JAEGER_SAMPLER_TYPE=const"
      - "JAEGER_TAGS=app=store-gateway-3"
    hostname: "store-gateway-3"
    image: "mimir"
    ports:
      - "8013:8013"
      - "10013:10013"
    volumes:
      - "./generated:/mimir/config"
      - "./activity:/activity"