apiVersion: v1
kind: Namespace
metadata:
  name: default
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: alertmanager
  name: alertmanager
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: alertmanager
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: compactor
  name: compactor
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: compactor
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: distributor-zone-a
  name: distributor-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: distributor-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: distributor-zone-b
  name: distributor-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: distributor-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memberlist-bridge-zone-a
  name: memberlist-bridge-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memberlist-bridge-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memberlist-bridge-zone-b
  name: memberlist-bridge-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memberlist-bridge-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached
  name: memcached
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-frontend
  name: memcached-frontend
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-frontend
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-frontend-zone-a
  name: memcached-frontend-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-frontend-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-frontend-zone-b
  name: memcached-frontend-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-frontend-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-index-queries
  name: memcached-index-queries
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-index-queries
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-index-queries-zone-a
  name: memcached-index-queries-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-index-queries-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-index-queries-zone-b
  name: memcached-index-queries-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-index-queries-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-metadata
  name: memcached-metadata
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-metadata
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-metadata-zone-a
  name: memcached-metadata-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-metadata-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-metadata-zone-b
  name: memcached-metadata-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-metadata-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-zone-a
  name: memcached-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: memcached-zone-b
  name: memcached-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: memcached-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: querier
  name: querier
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: querier
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: querier-zone-a
  name: querier-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: querier-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: querier-zone-b
  name: querier-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: querier-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-frontend
  name: query-frontend
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-frontend
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-frontend-zone-a
  name: query-frontend-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-frontend-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-frontend-zone-b
  name: query-frontend-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-frontend-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-scheduler
  name: query-scheduler
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-scheduler
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-scheduler-zone-a
  name: query-scheduler-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-scheduler-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: query-scheduler-zone-b
  name: query-scheduler-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: query-scheduler-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: rollout-operator
  name: rollout-operator
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: rollout-operator
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler
  name: ruler
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-querier
  name: ruler-querier
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-querier
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-querier-zone-a
  name: ruler-querier-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-querier-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-querier-zone-b
  name: ruler-querier-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-querier-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-frontend
  name: ruler-query-frontend
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-frontend
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-frontend-zone-a
  name: ruler-query-frontend-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-frontend-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-frontend-zone-b
  name: ruler-query-frontend-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-frontend-zone-b
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-scheduler
  name: ruler-query-scheduler
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-scheduler
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-scheduler-zone-a
  name: ruler-query-scheduler-zone-a
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-scheduler-zone-a
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  labels:
    name: ruler-query-scheduler-zone-b
  name: ruler-query-scheduler-zone-b
  namespace: default
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      name: ruler-query-scheduler-zone-b
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rollout-operator
  namespace: default
---
apiVersion: v1
data:
  overrides.yaml: |
    overrides: {}
kind: ConfigMap
metadata:
  name: overrides
  namespace: default
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zoneawarepoddisruptionbudgets.rollout-operator.grafana.com
spec:
  group: rollout-operator.grafana.com
  names:
    kind: ZoneAwarePodDisruptionBudget
    plural: zoneawarepoddisruptionbudgets
    shortNames:
    - zpdb
    singular: zoneawarepoddisruptionbudget
  scope: Namespaced
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        properties:
          spec:
            properties:
              maxUnavailable:
                description: The number of pods that can be unavailable within a zone
                  or partition.
                minimum: 0
                type: integer
              maxUnavailablePercentage:
                description: Calculate the maxUnavailable value as a percentage of
                  the StatefulSet's spec.Replica count. This option is not supported
                  when using podNamePartitionRegex.
                maximum: 100
                minimum: 0
                type: integer
              podNamePartitionRegex:
                description: A regular expression for returning a partition name given
                  a pod name. This field is optional and should only be used when
                  the ZoneAwarePodDisruptionBudget is to be scoped to a partition,
                  such as a multi-zone ingester deployment with ingest_storage_enabled.
                  Enabling this changes the ZPDB functionality such that minAvailability
                  is applied across ALL zones for a given partition. When not enabled,
                  the minAvailability is applied to pods within the eviction zone
                  assuming there are no disruptions in the other zones.
                type: string
              podNameRegexGroup:
                description: The regular expression capture group number that contains
                  the partition name. This field is only required when the podNamePartitionRegex
                  field is set and has more then one grouping. The default value is
                  1 and 1-based indexing is used.
                minimum: 1
                type: integer
              selector:
                description: A selector for finding pods and statefulsets that this
                  ZoneAwarePodDisruptionBudget applies to.
                properties:
                  matchLabels:
                    additionalProperties:
                      type: string
                    type: object
                required:
                - matchLabels
                type: object
            required:
            - selector
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rollout-operator-default-webhook-cert-update-role
rules:
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - validatingwebhookconfigurations
  - mutatingwebhookconfigurations
  verbs:
  - list
  - patch
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rollout-operator-default-webhook-cert-secret-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: rollout-operator-default-webhook-cert-update-role
subjects:
- kind: ServiceAccount
  name: rollout-operator
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rollout-operator-role
  namespace: default
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - list
  - get
  - watch
  - delete
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - list
  - get
  - watch
  - patch
- apiGroups:
  - apps
  resources:
  - statefulsets/status
  verbs:
  - update
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - update
  - create
- apiGroups:
  - rollout-operator.grafana.com
  resources:
  - zoneawarepoddisruptionbudgets
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rollout-operator-webhook-cert-secret-role
  namespace: default
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - create
- apiGroups:
  - ""
  resourceNames:
  - rollout-operator-self-signed-certificate
  resources:
  - secrets
  verbs:
  - update
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rollout-operator-rolebinding
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rollout-operator-role
subjects:
- kind: ServiceAccount
  name: rollout-operator
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rollout-operator-webhook-cert-secret-rolebinding
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rollout-operator-webhook-cert-secret-role
subjects:
- kind: ServiceAccount
  name: rollout-operator
  namespace: default
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: alertmanager
  name: alertmanager
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: alertmanager-http-metrics
    port: 8080
    targetPort: 8080
  - name: alertmanager-grpc
    port: 9095
    targetPort: 9095
  - name: alertmanager-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: alertmanager
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: compactor
  name: compactor
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: compactor-http-metrics
    port: 8080
    targetPort: 8080
  - name: compactor-grpc
    port: 9095
    targetPort: 9095
  - name: compactor-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: compactor
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: distributor-zone-a
  name: distributor-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: distributor-http-metrics
    port: 8080
    targetPort: 8080
  - name: distributor-grpc
    port: 9095
    targetPort: 9095
  - name: distributor-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: distributor-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: distributor-zone-b
  name: distributor-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: distributor-http-metrics
    port: 8080
    targetPort: 8080
  - name: distributor-grpc
    port: 9095
    targetPort: 9095
  - name: distributor-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: distributor-zone-b
---
apiVersion: v1
kind: Service
metadata:
  name: gossip-ring
  namespace: default
spec:
  clusterIP: None
  ports:
  - appProtocol: tcp
    name: gossip-ring
    port: 7946
    protocol: TCP
    targetPort: 7946
  selector:
    gossip_ring_member: "true"
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ingester-zone-a
  name: ingester-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ingester-http-metrics
    port: 8080
    targetPort: 8080
  - name: ingester-grpc
    port: 9095
    targetPort: 9095
  - name: ingester-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ingester-zone-a
    rollout-group: ingester
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ingester-zone-b
  name: ingester-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ingester-http-metrics
    port: 8080
    targetPort: 8080
  - name: ingester-grpc
    port: 9095
    targetPort: 9095
  - name: ingester-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ingester-zone-b
    rollout-group: ingester
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ingester-zone-c
  name: ingester-zone-c
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ingester-http-metrics
    port: 8080
    targetPort: 8080
  - name: ingester-grpc
    port: 9095
    targetPort: 9095
  - name: ingester-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ingester-zone-c
    rollout-group: ingester
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached
  name: memcached
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-frontend
  name: memcached-frontend
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-frontend
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-frontend-zone-a
  name: memcached-frontend-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-frontend-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-frontend-zone-b
  name: memcached-frontend-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-frontend-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-index-queries
  name: memcached-index-queries
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-index-queries
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-index-queries-zone-a
  name: memcached-index-queries-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-index-queries-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-index-queries-zone-b
  name: memcached-index-queries-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-index-queries-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-metadata
  name: memcached-metadata
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-metadata
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-metadata-multi-zone
  name: memcached-metadata-multi-zone
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    protocol: TCP
    targetPort: 11211
  selector:
    cache-group: metadata
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-metadata-zone-a
  name: memcached-metadata-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    cache-group: metadata
    name: memcached-metadata-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-metadata-zone-b
  name: memcached-metadata-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    cache-group: metadata
    name: memcached-metadata-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-zone-a
  name: memcached-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: memcached-zone-b
  name: memcached-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: memcached-client
    port: 11211
    targetPort: 11211
  - name: exporter-http-metrics
    port: 9150
    targetPort: 9150
  selector:
    name: memcached-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: querier
  name: querier
  namespace: default
spec:
  ports:
  - name: querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: querier-grpc
    port: 9095
    targetPort: 9095
  - name: querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: querier
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: querier-zone-a
  name: querier-zone-a
  namespace: default
spec:
  ports:
  - name: querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: querier-grpc
    port: 9095
    targetPort: 9095
  - name: querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: querier-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: querier-zone-b
  name: querier-zone-b
  namespace: default
spec:
  ports:
  - name: querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: querier-grpc
    port: 9095
    targetPort: 9095
  - name: querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: querier-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-frontend
  name: query-frontend
  namespace: default
spec:
  ports:
  - name: query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-frontend
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-frontend-zone-a
  name: query-frontend-zone-a
  namespace: default
spec:
  ports:
  - name: query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-frontend-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-frontend-zone-b
  name: query-frontend-zone-b
  namespace: default
spec:
  ports:
  - name: query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-frontend-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-scheduler
  name: query-scheduler
  namespace: default
spec:
  ports:
  - name: query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-scheduler
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-scheduler
  name: query-scheduler-discovery
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  publishNotReadyAddresses: true
  selector:
    name: query-scheduler
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-scheduler-zone-a
  name: query-scheduler-zone-a
  namespace: default
spec:
  ports:
  - name: query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-scheduler-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: query-scheduler-zone-b
  name: query-scheduler-zone-b
  namespace: default
spec:
  ports:
  - name: query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: query-scheduler-zone-b
---
apiVersion: v1
kind: Service
metadata:
  name: rollout-operator
  namespace: default
spec:
  ports:
  - name: https
    port: 443
    protocol: TCP
    targetPort: 8443
  selector:
    name: rollout-operator
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler
  name: ruler
  namespace: default
spec:
  ports:
  - name: ruler-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-grpc
    port: 9095
    targetPort: 9095
  selector:
    name: ruler
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-querier
  name: ruler-querier
  namespace: default
spec:
  ports:
  - name: ruler-querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-querier-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-querier
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-querier-zone-a
  name: ruler-querier-zone-a
  namespace: default
spec:
  ports:
  - name: ruler-querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-querier-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-querier-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-querier-zone-b
  name: ruler-querier-zone-b
  namespace: default
spec:
  ports:
  - name: ruler-querier-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-querier-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-querier-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-querier-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-frontend
  name: ruler-query-frontend
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ruler-query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-frontend
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-frontend-zone-a
  name: ruler-query-frontend-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ruler-query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-frontend-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-frontend-zone-b
  name: ruler-query-frontend-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ruler-query-frontend-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-frontend-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-frontend-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-frontend-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-scheduler
  name: ruler-query-scheduler
  namespace: default
spec:
  ports:
  - name: ruler-query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-scheduler
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-scheduler
  name: ruler-query-scheduler-discovery
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: ruler-query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  publishNotReadyAddresses: true
  selector:
    name: ruler-query-scheduler
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-scheduler-zone-a
  name: ruler-query-scheduler-zone-a
  namespace: default
spec:
  ports:
  - name: ruler-query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-scheduler-zone-a
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: ruler-query-scheduler-zone-b
  name: ruler-query-scheduler-zone-b
  namespace: default
spec:
  ports:
  - name: ruler-query-scheduler-http-metrics
    port: 8080
    targetPort: 8080
  - name: ruler-query-scheduler-grpc
    port: 9095
    targetPort: 9095
  - name: ruler-query-scheduler-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: ruler-query-scheduler-zone-b
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: store-gateway-multi-zone
  name: store-gateway-multi-zone
  namespace: default
spec:
  ports:
  - name: store-gateway-http-metrics
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    rollout-group: store-gateway
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: store-gateway-zone-a
  name: store-gateway-zone-a
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: store-gateway-http-metrics
    port: 8080
    targetPort: 8080
  - name: store-gateway-grpc
    port: 9095
    targetPort: 9095
  - name: store-gateway-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: store-gateway-zone-a
    rollout-group: store-gateway
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: store-gateway-zone-b
  name: store-gateway-zone-b
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: store-gateway-http-metrics
    port: 8080
    targetPort: 8080
  - name: store-gateway-grpc
    port: 9095
    targetPort: 9095
  - name: store-gateway-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: store-gateway-zone-b
    rollout-group: store-gateway
---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: store-gateway-zone-c
  name: store-gateway-zone-c
  namespace: default
spec:
  clusterIP: None
  ports:
  - name: store-gateway-http-metrics
    port: 8080
    targetPort: 8080
  - name: store-gateway-grpc
    port: 9095
    targetPort: 9095
  - name: store-gateway-gossip-ring
    port: 7946
    targetPort: 7946
  selector:
    name: store-gateway-zone-c
    rollout-group: store-gateway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: distributor-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: distributor-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: distributor-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
      containers:
      - args:
        - -distributor.ha-tracker.enable=true
        - -distributor.ha-tracker.enable-for-all-users=true
        - -distributor.ha-tracker.prefix=prom_ha/
        - -distributor.ha-tracker.store=memberlist
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-burst-size=200000
        - -distributor.ingestion-rate-limit=10000
        - -distributor.ingestion-tenant-shard-size=3
        - -distributor.ring.heartbeat-period=1m
        - -distributor.ring.heartbeat-timeout=4m
        - -distributor.ring.prefix=
        - -distributor.ring.store=memberlist
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=1073741824
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=1000
        - -server.grpc.keepalive.max-connection-age=60s
        - -server.grpc.keepalive.max-connection-age-grace=5m
        - -server.grpc.keepalive.max-connection-idle=1m
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=distributor
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: GOMAXPROCS
          value: "8"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: distributor
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 4Gi
          requests:
            cpu: "2"
            memory: 2Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 100
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: distributor-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: distributor-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: distributor-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: distributor-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
      containers:
      - args:
        - -distributor.ha-tracker.enable=true
        - -distributor.ha-tracker.enable-for-all-users=true
        - -distributor.ha-tracker.prefix=prom_ha/
        - -distributor.ha-tracker.store=memberlist
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-burst-size=200000
        - -distributor.ingestion-rate-limit=10000
        - -distributor.ingestion-tenant-shard-size=3
        - -distributor.ring.heartbeat-period=1m
        - -distributor.ring.heartbeat-timeout=4m
        - -distributor.ring.prefix=
        - -distributor.ring.store=memberlist
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=1073741824
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=1000
        - -server.grpc.keepalive.max-connection-age=60s
        - -server.grpc.keepalive.max-connection-age-grace=5m
        - -server.grpc.keepalive.max-connection-idle=1m
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=distributor
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: GOMAXPROCS
          value: "8"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: distributor
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 4Gi
          requests:
            cpu: "2"
            memory: 2Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 100
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: distributor-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memberlist-bridge-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: memberlist-bridge-zone-a
  strategy:
    rollingUpdate:
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: memberlist-bridge-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memberlist-bridge-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.max-concurrent-writes=15
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=bridge
        - -query-scheduler.ring.prefix=
        - -query-scheduler.ring.store=memberlist
        - -server.http-listen-port=8080
        - -target=memberlist-kv
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: memberlist-bridge
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "0.25"
            memory: 1Gi
      priorityClassName: high-nonpreempting
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: memberlist-bridge-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memberlist-bridge-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: memberlist-bridge-zone-b
  strategy:
    rollingUpdate:
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: memberlist-bridge-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memberlist-bridge-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.max-concurrent-writes=15
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=bridge
        - -query-scheduler.ring.prefix=
        - -query-scheduler.ring.store=memberlist
        - -server.http-listen-port=8080
        - -target=memberlist-kv
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: memberlist-bridge
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "0.25"
            memory: 1Gi
      priorityClassName: high-nonpreempting
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: memberlist-bridge-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: querier
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: querier
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: querier
    spec:
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: GOMAXPROCS
          value: "5"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: querier
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: querier-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: querier-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: querier-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.prefer-availability-zones=zone-a
        - -querier.ring.prefix=querier-zone-a/
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: GOMAXPROCS
          value: "5"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: querier-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: querier-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: querier-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: querier-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.prefer-availability-zones=zone-b
        - -querier.ring.prefix=querier-zone-b/
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: GOMAXPROCS
          value: "5"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: querier-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-frontend
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-frontend
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-frontend
    spec:
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.cache-results=true
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: query-frontend
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-frontend-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-frontend-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-frontend-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.ring.prefix=querier-zone-a/
        - -query-frontend.cache-results=true
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: query-frontend-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-frontend-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-frontend-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-frontend-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -querier.ring.prefix=querier-zone-b/
        - -query-frontend.cache-results=true
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: query-frontend-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-scheduler
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-scheduler
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-scheduler
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: query-scheduler
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-scheduler-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-scheduler-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-scheduler-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: query-scheduler-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-scheduler-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: query-scheduler-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: query-scheduler-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: query-scheduler-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rollout-operator
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: rollout-operator
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
  template:
    metadata:
      labels:
        name: rollout-operator
    spec:
      containers:
      - args:
        - -kubernetes.namespace=default
        - -server-tls.enabled=true
        - -use-zone-tracker=true
        - -zone-tracker.config-map-name=rollout-operator-zone-tracker
        image: grafana/rollout-operator:v0.34.0
        imagePullPolicy: IfNotPresent
        name: rollout-operator
        ports:
        - containerPort: 8001
          name: http-metrics
        - containerPort: 8443
          name: https
        readinessProbe:
          httpGet:
            path: /ready
            port: 8001
          initialDelaySeconds: 5
          timeoutSeconds: 1
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi
      serviceAccountName: rollout-operator
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler
    spec:
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -distributor.remote-timeout=10s
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=1073741824
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.max-partial-query-length=768h
        - -ruler-storage.cache.backend=memcached
        - -ruler-storage.cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -ruler-storage.cache.memcached.max-async-concurrency=50
        - -ruler-storage.cache.memcached.max-item-size=1048576
        - -ruler-storage.cache.memcached.timeout=500ms
        - -ruler-storage.gcs.bucket-name=rules-bucket
        - -ruler.alertmanager-url=http://alertmanager.default.svc.cluster.local./alertmanager
        - -ruler.max-rule-groups-per-tenant=85
        - -ruler.max-rules-per-rule-group=20
        - -ruler.query-frontend.address=dns:///ruler-query-frontend.default.svc.cluster.local.:9095
        - -ruler.query-frontend.grpc-client-config.grpc-max-recv-msg-size=104857600
        - -ruler.ring.store=memberlist
        - -ruler.rule-path=/rules
        - -ruler.tenant-shard-size=2
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=ruler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            cpu: "16"
            memory: 16Gi
          requests:
            cpu: "1"
            memory: 6Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 600
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-querier
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-querier
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-querier
    spec:
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.ring.prefix=ruler-querier/
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=ruler-query-scheduler/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env: []
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-querier
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-querier-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-querier-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-querier-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.prefer-availability-zones=zone-a
        - -querier.ring.prefix=ruler-querier-zone-a/
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env: []
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-querier-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-querier-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-querier-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-querier-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
      containers:
      - args:
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.zone-awareness-enabled=true
        - -mem-ballast-size-bytes=268435456
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -querier.frontend-client.grpc-max-send-msg-size=104857600
        - -querier.max-concurrent=8
        - -querier.max-partial-query-length=768h
        - -querier.prefer-availability-zones=zone-b
        - -querier.ring.prefix=ruler-querier-zone-b/
        - -querier.store-gateway-client.grpc-max-recv-msg-size=209715200
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=querier
        - -usage-stats.installation-mode=jsonnet
        env: []
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-querier
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 24Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-querier-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-frontend
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-frontend
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-frontend
    spec:
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.ring.prefix=ruler-querier/
        - -query-frontend.cache-results=false
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=ruler-query-scheduler/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=300
        - -server.grpc-max-recv-msg-size-bytes=104857600
        - -server.grpc-max-send-msg-size-bytes=104857600
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.max-connection-age-grace=5m
        - -server.grpc.keepalive.max-connection-idle=1m
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-query-frontend
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-frontend-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-frontend-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-frontend-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -querier.ring.prefix=ruler-querier-zone-a/
        - -query-frontend.cache-results=false
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=300
        - -server.grpc-max-recv-msg-size-bytes=104857600
        - -server.grpc-max-send-msg-size-bytes=104857600
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.max-connection-age-grace=5m
        - -server.grpc.keepalive.max-connection-idle=1m
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-query-frontend-zone-a
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-frontend-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-frontend-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 15%
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-frontend-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -querier.ring.prefix=ruler-querier-zone-b/
        - -query-frontend.cache-results=false
        - -query-frontend.max-cache-freshness=10m
        - -query-frontend.max-queriers-per-tenant=10
        - -query-frontend.max-total-query-length=12000h
        - -query-frontend.query-sharding-target-series-per-shard=2500
        - -query-frontend.results-cache.backend=memcached
        - -query-frontend.results-cache.memcached.addresses=dnssrvnoa+memcached-frontend.default.svc.cluster.local.:11211
        - -query-frontend.results-cache.memcached.max-item-size=5242880
        - -query-frontend.results-cache.memcached.timeout=500ms
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=300
        - -server.grpc-max-recv-msg-size-bytes=104857600
        - -server.grpc-max-send-msg-size-bytes=104857600
        - -server.grpc.keepalive.max-connection-age=30s
        - -server.grpc.keepalive.max-connection-age-grace=5m
        - -server.grpc.keepalive.max-connection-idle=1m
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -shutdown-delay=90s
        - -target=query-frontend
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-frontend
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 1200Mi
          requests:
            cpu: "2"
            memory: 600Mi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 390
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            name: ruler-query-frontend-zone-b
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-scheduler
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-scheduler
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-scheduler
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: ruler-query-scheduler
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=ruler-query-scheduler/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-scheduler-zone-a
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-scheduler-zone-a
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-scheduler-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: ruler-query-scheduler-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-a/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruler-query-scheduler-zone-b
  namespace: default
spec:
  minReadySeconds: 10
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      name: ruler-query-scheduler-zone-b
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ruler-query-scheduler-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: ruler-query-scheduler-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-b
        - -memberlist.zone-aware-routing.role=member
        - -query-frontend.max-queriers-per-tenant=10
        - -query-scheduler.max-outstanding-requests-per-tenant=100
        - -query-scheduler.ring.prefix=ruler-query-scheduler-zone-b/
        - -query-scheduler.ring.store=memberlist
        - -query-scheduler.service-discovery-mode=ring
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=query-scheduler
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ruler-query-scheduler
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
        volumeMounts:
        - mountPath: /etc/mimir
          name: overrides
      terminationGracePeriodSeconds: 180
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
      volumes:
      - configMap:
          name: overrides
        name: overrides
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    name: alertmanager
  name: alertmanager
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      name: alertmanager
  serviceName: alertmanager
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: alertmanager
    spec:
      containers:
      - args:
        - -alertmanager-storage.gcs.bucket-name=alerts-bucket
        - -alertmanager.sharding-ring.replication-factor=3
        - -alertmanager.sharding-ring.store=memberlist
        - -alertmanager.storage.path=/data
        - -alertmanager.web.external-url=http://test/alertmanager
        - -common.storage.backend=gcs
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-idle-timeout=6m
        - -server.http-listen-port=8080
        - -target=alertmanager
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: alertmanager
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 15Gi
          requests:
            cpu: "2"
            memory: 10Gi
        volumeMounts:
        - mountPath: /data
          name: alertmanager-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 900
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: alertmanager-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    name: compactor
  name: compactor
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: compactor
  serviceName: compactor
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: compactor
    spec:
      containers:
      - args:
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -compactor.block-ranges=2h,12h,24h
        - -compactor.blocks-retention-period=0
        - -compactor.cleanup-interval=15m
        - -compactor.compaction-concurrency=1
        - -compactor.compaction-interval=30m
        - -compactor.compactor-tenant-shard-size=1
        - -compactor.data-dir=/data
        - -compactor.deletion-delay=2h
        - -compactor.first-level-compaction-wait-period=25m
        - -compactor.max-closing-blocks-concurrency=2
        - -compactor.max-opening-blocks-concurrency=4
        - -compactor.ring.heartbeat-period=1m
        - -compactor.ring.heartbeat-timeout=4m
        - -compactor.ring.prefix=
        - -compactor.ring.store=memberlist
        - -compactor.ring.wait-stability-min-duration=1m
        - -compactor.split-and-merge-shards=0
        - -compactor.split-groups=1
        - -compactor.symbols-flushers-concurrency=4
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=compactor
        - -usage-stats.installation-mode=jsonnet
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: compactor
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 6Gi
          requests:
            cpu: 1
            memory: 6Gi
        volumeMounts:
        - mountPath: /data
          name: compactor-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 900
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: compactor-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 250Gi
      storageClassName: standard
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: ingester
  name: ingester-zone-a
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: ingester-zone-a
      rollout-group: ingester
  serviceName: ingester-zone-a
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ingester-zone-a
        rollout-group: ingester
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - ingester
              - key: name
                operator: NotIn
                values:
                - ingester-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -blocks-storage.tsdb.block-ranges-period=2h
        - -blocks-storage.tsdb.dir=/data/tsdb
        - -blocks-storage.tsdb.head-compaction-interval=15m
        - -blocks-storage.tsdb.ship-interval=1m
        - -blocks-storage.tsdb.wal-replay-concurrency=3
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.max-global-metadata-per-metric=10
        - -ingester.max-global-metadata-per-user=30000
        - -ingester.max-global-series-per-user=150000
        - -ingester.ring.heartbeat-period=2m
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.instance-availability-zone=zone-a
        - -ingester.ring.num-tokens=512
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.tokens-file-path=/data/tokens
        - -ingester.ring.unregister-on-shutdown=true
        - -ingester.ring.zone-awareness-enabled=true
        - -memberlist.abort-if-fast-join-fails=true
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=500
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=ingester
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: ingester-a-only
        - name: GOGC
          value: "off"
        - name: GOMAXPROCS
          value: "9"
        - name: GOMEMLIMIT
          value: 1Gi
        - name: Z
          value: "123"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ingester
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 25Gi
          requests:
            cpu: "4"
            memory: 15Gi
        volumeMounts:
        - mountPath: /data
          name: ingester-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 1200
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ingester-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: ingester
  name: ingester-zone-b
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: ingester-zone-b
      rollout-group: ingester
  serviceName: ingester-zone-b
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ingester-zone-b
        rollout-group: ingester
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - ingester
              - key: name
                operator: NotIn
                values:
                - ingester-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -blocks-storage.tsdb.block-ranges-period=2h
        - -blocks-storage.tsdb.dir=/data/tsdb
        - -blocks-storage.tsdb.head-compaction-interval=15m
        - -blocks-storage.tsdb.ship-interval=1m
        - -blocks-storage.tsdb.wal-replay-concurrency=3
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.max-global-metadata-per-metric=10
        - -ingester.max-global-metadata-per-user=30000
        - -ingester.max-global-series-per-user=150000
        - -ingester.ring.heartbeat-period=2m
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.instance-availability-zone=zone-b
        - -ingester.ring.num-tokens=512
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.tokens-file-path=/data/tokens
        - -ingester.ring.unregister-on-shutdown=true
        - -ingester.ring.zone-awareness-enabled=true
        - -memberlist.abort-if-fast-join-fails=true
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=500
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=ingester
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: all-ingesters
        - name: GOMAXPROCS
          value: "9"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ingester
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 25Gi
          requests:
            cpu: "4"
            memory: 15Gi
        volumeMounts:
        - mountPath: /data
          name: ingester-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 1200
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ingester-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: ingester
  name: ingester-zone-c
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: ingester-zone-c
      rollout-group: ingester
  serviceName: ingester-zone-c
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: ingester-zone-c
        rollout-group: ingester
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - ingester
              - key: name
                operator: NotIn
                values:
                - ingester-zone-c
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -blocks-storage.tsdb.block-ranges-period=2h
        - -blocks-storage.tsdb.dir=/data/tsdb
        - -blocks-storage.tsdb.head-compaction-interval=15m
        - -blocks-storage.tsdb.ship-interval=1m
        - -blocks-storage.tsdb.wal-replay-concurrency=3
        - -common.storage.backend=gcs
        - -distributor.health-check-ingesters=true
        - -distributor.ingestion-tenant-shard-size=3
        - -ingester.max-global-metadata-per-metric=10
        - -ingester.max-global-metadata-per-user=30000
        - -ingester.max-global-series-per-user=150000
        - -ingester.ring.heartbeat-period=2m
        - -ingester.ring.heartbeat-timeout=10m
        - -ingester.ring.instance-availability-zone=zone-c
        - -ingester.ring.num-tokens=512
        - -ingester.ring.prefix=
        - -ingester.ring.replication-factor=3
        - -ingester.ring.store=memberlist
        - -ingester.ring.tokens-file-path=/data/tokens
        - -ingester.ring.unregister-on-shutdown=true
        - -ingester.ring.zone-awareness-enabled=true
        - -memberlist.abort-if-fast-join-fails=true
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-concurrent-streams=500
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -target=ingester
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: all-ingesters
        - name: GOMAXPROCS
          value: "9"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: ingester
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 25Gi
          requests:
            cpu: "4"
            memory: 15Gi
        volumeMounts:
        - mountPath: /data
          name: ingester-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 1200
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ingester-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached
  serviceName: memcached
  template:
    metadata:
      labels:
        name: memcached
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 6144
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 9Gi
          requests:
            cpu: 500m
            memory: 6552Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-frontend
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-frontend
  serviceName: memcached-frontend
  template:
    metadata:
      labels:
        name: memcached-frontend
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-frontend
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-frontend-zone-a
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-frontend-zone-a
  serviceName: memcached-frontend-zone-a
  template:
    metadata:
      labels:
        name: memcached-frontend-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-frontend-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-frontend-zone-b
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-frontend-zone-b
  serviceName: memcached-frontend-zone-b
  template:
    metadata:
      labels:
        name: memcached-frontend-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-frontend-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-index-queries
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-index-queries
  serviceName: memcached-index-queries
  template:
    metadata:
      labels:
        name: memcached-index-queries
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-index-queries
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-index-queries-zone-a
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-index-queries-zone-a
  serviceName: memcached-index-queries-zone-a
  template:
    metadata:
      labels:
        name: memcached-index-queries-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-index-queries-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-index-queries-zone-b
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-index-queries-zone-b
  serviceName: memcached-index-queries-zone-b
  template:
    metadata:
      labels:
        name: memcached-index-queries-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-index-queries-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 1024
        - -I 5m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 1536Mi
          requests:
            cpu: 500m
            memory: 1176Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-metadata
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-metadata
  serviceName: memcached-metadata
  template:
    metadata:
      labels:
        name: memcached-metadata
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-metadata
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 512
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 768Mi
          requests:
            cpu: 500m
            memory: 638Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-metadata-zone-a
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-metadata-zone-a
  serviceName: memcached-metadata-zone-a
  template:
    metadata:
      labels:
        cache-group: metadata
        name: memcached-metadata-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-metadata-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 512
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 768Mi
          requests:
            cpu: 500m
            memory: 638Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-metadata-zone-b
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-metadata-zone-b
  serviceName: memcached-metadata-zone-b
  template:
    metadata:
      labels:
        cache-group: metadata
        name: memcached-metadata-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-metadata-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 512
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 768Mi
          requests:
            cpu: 500m
            memory: 638Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-zone-a
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-zone-a
  serviceName: memcached-zone-a
  template:
    metadata:
      labels:
        name: memcached-zone-a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2a
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 6144
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 9Gi
          requests:
            cpu: 500m
            memory: 6552Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcached-zone-b
  namespace: default
spec:
  minReadySeconds: 60
  replicas: 3
  selector:
    matchLabels:
      name: memcached-zone-b
  serviceName: memcached-zone-b
  template:
    metadata:
      labels:
        name: memcached-zone-b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - us-east-2b
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                name: memcached-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -m 6144
        - -I 1m
        - -c 16384
        - -v
        image: memcached:1.6.34-alpine
        imagePullPolicy: IfNotPresent
        name: memcached
        ports:
        - containerPort: 11211
          name: client
        resources:
          limits:
            memory: 9Gi
          requests:
            cpu: 500m
            memory: 6552Mi
      - args:
        - --memcached.address=localhost:11211
        - --web.listen-address=0.0.0.0:9150
        image: prom/memcached-exporter:v0.15.3
        imagePullPolicy: IfNotPresent
        name: exporter
        ports:
        - containerPort: 9150
          name: http-metrics
        resources:
          limits:
            memory: 250Mi
          requests:
            cpu: "0.05"
            memory: 50Mi
      tolerations:
      - effect: NoSchedule
        key: topology
        operator: Equal
        value: secondary-az
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: store-gateway
  name: store-gateway-zone-a
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: store-gateway-zone-a
      rollout-group: store-gateway
  serviceName: store-gateway-zone-a
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: store-gateway-zone-a
        rollout-group: store-gateway
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - store-gateway
              - key: name
                operator: NotIn
                values:
                - store-gateway-zone-a
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.bucket-store.chunks-cache.backend=memcached
        - -blocks-storage.bucket-store.chunks-cache.memcached.addresses=dnssrvnoa+memcached.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.chunks-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.index-cache.backend=memcached
        - -blocks-storage.bucket-store.index-cache.memcached.addresses=dnssrvnoa+memcached-index-queries.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.index-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.index-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.index-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.index-cache.memcached.max-item-size=5242880
        - -blocks-storage.bucket-store.index-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-send-msg-size-bytes=209715200
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-period=1m
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.instance-availability-zone=zone-a
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.tokens-file-path=/data/tokens
        - -store-gateway.sharding-ring.unregister-on-shutdown=false
        - -store-gateway.sharding-ring.wait-stability-min-duration=1m
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=store-gateway
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: all-store-gateways
        - name: GOMAXPROCS
          value: "5"
        - name: GOMEMLIMIT
          value: "12884901888"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: store-gateway
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 18Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /data
          name: store-gateway-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 120
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: store-gateway-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
      storageClassName: standard
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: store-gateway
  name: store-gateway-zone-b
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: store-gateway-zone-b
      rollout-group: store-gateway
  serviceName: store-gateway-zone-b
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: store-gateway-zone-b
        rollout-group: store-gateway
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - store-gateway
              - key: name
                operator: NotIn
                values:
                - store-gateway-zone-b
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.bucket-store.chunks-cache.backend=memcached
        - -blocks-storage.bucket-store.chunks-cache.memcached.addresses=dnssrvnoa+memcached.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.chunks-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.index-cache.backend=memcached
        - -blocks-storage.bucket-store.index-cache.memcached.addresses=dnssrvnoa+memcached-index-queries.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.index-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.index-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.index-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.index-cache.memcached.max-item-size=5242880
        - -blocks-storage.bucket-store.index-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-send-msg-size-bytes=209715200
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-period=1m
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.instance-availability-zone=zone-b
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.tokens-file-path=/data/tokens
        - -store-gateway.sharding-ring.unregister-on-shutdown=false
        - -store-gateway.sharding-ring.wait-stability-min-duration=1m
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=store-gateway
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: zone-b
        - name: GOGC
          value: "1000"
        - name: GOMAXPROCS
          value: "5"
        - name: GOMEMLIMIT
          value: "12884901888"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: store-gateway
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 18Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /data
          name: store-gateway-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 120
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: store-gateway-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
      storageClassName: standard
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    rollout-max-unavailable: "50"
  labels:
    rollout-group: store-gateway
  name: store-gateway-zone-c
  namespace: default
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      name: store-gateway-zone-c
      rollout-group: store-gateway
  serviceName: store-gateway-zone-c
  template:
    metadata:
      labels:
        gossip_ring_member: "true"
        name: store-gateway-zone-c
        rollout-group: store-gateway
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: rollout-group
                operator: In
                values:
                - store-gateway
              - key: name
                operator: NotIn
                values:
                - store-gateway-zone-c
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - -blocks-storage.bucket-store.chunks-cache.backend=memcached
        - -blocks-storage.bucket-store.chunks-cache.memcached.addresses=dnssrvnoa+memcached.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.chunks-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.chunks-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.index-cache.backend=memcached
        - -blocks-storage.bucket-store.index-cache.memcached.addresses=dnssrvnoa+memcached-index-queries.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.index-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.index-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.index-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.index-cache.memcached.max-item-size=5242880
        - -blocks-storage.bucket-store.index-cache.memcached.timeout=750ms
        - -blocks-storage.bucket-store.metadata-cache.backend=memcached
        - -blocks-storage.bucket-store.metadata-cache.memcached.addresses=dnssrvnoa+memcached-metadata.default.svc.cluster.local.:11211
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-async-concurrency=50
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-get-multi-concurrency=100
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-idle-connections=150
        - -blocks-storage.bucket-store.metadata-cache.memcached.max-item-size=1048576
        - -blocks-storage.bucket-store.sync-dir=/data/tsdb
        - -blocks-storage.bucket-store.sync-interval=15m
        - -blocks-storage.gcs.bucket-name=blocks-bucket
        - -common.storage.backend=gcs
        - -memberlist.bind-port=7946
        - -memberlist.join=dns+gossip-ring.default.svc.cluster.local.:7946
        - -memberlist.zone-aware-routing.enabled=true
        - -memberlist.zone-aware-routing.instance-availability-zone=zone-a
        - -memberlist.zone-aware-routing.role=member
        - -runtime-config.file=/etc/mimir/overrides.yaml
        - -server.grpc-max-send-msg-size-bytes=209715200
        - -server.grpc.keepalive.min-time-between-pings=10s
        - -server.grpc.keepalive.ping-without-stream-allowed=true
        - -server.http-listen-port=8080
        - -store-gateway.sharding-ring.heartbeat-period=1m
        - -store-gateway.sharding-ring.heartbeat-timeout=10m
        - -store-gateway.sharding-ring.instance-availability-zone=zone-c
        - -store-gateway.sharding-ring.prefix=multi-zone/
        - -store-gateway.sharding-ring.replication-factor=3
        - -store-gateway.sharding-ring.store=memberlist
        - -store-gateway.sharding-ring.tokens-file-path=/data/tokens
        - -store-gateway.sharding-ring.unregister-on-shutdown=false
        - -store-gateway.sharding-ring.wait-stability-min-duration=1m
        - -store-gateway.sharding-ring.zone-awareness-enabled=true
        - -store-gateway.tenant-shard-size=3
        - -target=store-gateway
        - -usage-stats.installation-mode=jsonnet
        env:
        - name: A
          value: all-store-gateways
        - name: GOMAXPROCS
          value: "5"
        - name: GOMEMLIMIT
          value: "12884901888"
        image: grafana/mimir:3.0.2
        imagePullPolicy: IfNotPresent
        name: store-gateway
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 9095
          name: grpc
        - containerPort: 7946
          name: gossip-ring
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        resources:
          limits:
            memory: 18Gi
          requests:
            cpu: "1"
            memory: 12Gi
        volumeMounts:
        - mountPath: /data
          name: store-gateway-data
        - mountPath: /etc/mimir
          name: overrides
      securityContext:
        runAsUser: 0
      terminationGracePeriodSeconds: 120
      volumes:
      - configMap:
          name: overrides
        name: overrides
  updateStrategy:
    type: OnDelete
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: store-gateway-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
      storageClassName: standard
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  labels:
    grafana.com/inject-rollout-operator-ca: "true"
    grafana.com/namespace: default
  name: prepare-downscale-default
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: rollout-operator
      namespace: default
      path: /admission/prepare-downscale
      port: 443
  failurePolicy: Fail
  matchPolicy: Equivalent
  name: prepare-downscale-default.grafana.com
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: default
  rules:
  - apiGroups:
    - apps
    apiVersions:
    - v1
    operations:
    - UPDATE
    resources:
    - statefulsets
    - statefulsets/scale
    scope: Namespaced
  sideEffects: NoneOnDryRun
  timeoutSeconds: 10
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: querier
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 10
          stabilizationWindowSeconds: 600
        scaleUp:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 50
          - periodSeconds: 120
            type: Pods
            value: 15
          stabilizationWindowSeconds: 60
  maxReplicaCount: 30
  minReplicaCount: 3
  pollingInterval: 10
  scaleTargetRef:
    name: querier
  triggers:
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="query-scheduler",namespace="default",quantile="0.5",pod!~"(querier|query-scheduler)-zone.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_hpa_default_requests_duration
      query: sum(rate(cortex_querier_request_duration_seconds_sum{container="querier",namespace="default",pod!~"(querier|query-scheduler)-zone.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_hpa_default_requests_duration
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: querier-zone-a
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 10
          stabilizationWindowSeconds: 600
        scaleUp:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 50
          - periodSeconds: 120
            type: Pods
            value: 15
          stabilizationWindowSeconds: 60
  maxReplicaCount: 30
  minReplicaCount: 3
  pollingInterval: 10
  scaleTargetRef:
    name: querier-zone-a
  triggers:
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_zone_a_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="query-scheduler",namespace="default",quantile="0.5",pod=~"(querier|query-scheduler)-zone-a.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_zone_a_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_zone_a_hpa_default_requests_duration
      query: sum(rate(cortex_querier_request_duration_seconds_sum{container="querier",namespace="default",pod=~"(querier|query-scheduler)-zone-a.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_zone_a_hpa_default_requests_duration
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: querier-zone-b
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 10
          stabilizationWindowSeconds: 600
        scaleUp:
          policies:
          - periodSeconds: 120
            type: Percent
            value: 50
          - periodSeconds: 120
            type: Pods
            value: 15
          stabilizationWindowSeconds: 60
  maxReplicaCount: 30
  minReplicaCount: 3
  pollingInterval: 10
  scaleTargetRef:
    name: querier-zone-b
  triggers:
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_zone_b_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="query-scheduler",namespace="default",quantile="0.5",pod=~"(querier|query-scheduler)-zone-b.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_zone_b_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "true"
      metricName: cortex_querier_zone_b_hpa_default_requests_duration
      query: sum(rate(cortex_querier_request_duration_seconds_sum{container="querier",namespace="default",pod=~"(querier|query-scheduler)-zone-b.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: cortex_querier_zone_b_hpa_default_requests_duration
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: query-frontend
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 20
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: query-frontend
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="query-frontend",namespace="default",pod!~"query-frontend-zone.*"}[5m]))
            and
            max by (pod) (up{container="query-frontend",namespace="default",pod!~"query-frontend-zone.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1500"
    name: query_frontend_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="query-frontend",namespace="default",pod!~"query-frontend-zone.*"})
              and
              max by (pod) (up{container="query-frontend",namespace="default",pod!~"query-frontend-zone.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="query-frontend", namespace="default", resource="memory",pod!~"query-frontend-zone.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="query-frontend", namespace="default",pod!~"query-frontend-zone.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="query-frontend", namespace="default", reason="OOMKilled",pod!~"query-frontend-zone.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: query_frontend_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: query-frontend-zone-a
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 20
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: query-frontend-zone-a
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_zone_a_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="query-frontend",namespace="default",pod=~"query-frontend-zone-a.*"}[5m]))
            and
            max by (pod) (up{container="query-frontend",namespace="default",pod=~"query-frontend-zone-a.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1500"
    name: query_frontend_zone_a_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_zone_a_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="query-frontend",namespace="default",pod=~"query-frontend-zone-a.*"})
              and
              max by (pod) (up{container="query-frontend",namespace="default",pod=~"query-frontend-zone-a.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="query-frontend", namespace="default", resource="memory",pod=~"query-frontend-zone-a.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="query-frontend", namespace="default",pod=~"query-frontend-zone-a.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="query-frontend", namespace="default", reason="OOMKilled",pod=~"query-frontend-zone-a.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: query_frontend_zone_a_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: query-frontend-zone-b
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 20
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: query-frontend-zone-b
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_zone_b_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="query-frontend",namespace="default",pod=~"query-frontend-zone-b.*"}[5m]))
            and
            max by (pod) (up{container="query-frontend",namespace="default",pod=~"query-frontend-zone-b.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1500"
    name: query_frontend_zone_b_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: query_frontend_zone_b_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="query-frontend",namespace="default",pod=~"query-frontend-zone-b.*"})
              and
              max by (pod) (up{container="query-frontend",namespace="default",pod=~"query-frontend-zone-b.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="query-frontend", namespace="default", resource="memory",pod=~"query-frontend-zone-b.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="query-frontend", namespace="default",pod=~"query-frontend-zone-b.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="query-frontend", namespace="default", reason="OOMKilled",pod=~"query-frontend-zone-b.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: query_frontend_zone_b_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 600
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler",namespace="default"}[5m]))
            and
            max by (pod) (up{container="ruler",namespace="default"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1000"
    name: ruler_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler",namespace="default"})
              and
              max by (pod) (up{container="ruler",namespace="default"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler", namespace="default", resource="memory"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler", namespace="default"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler", namespace="default", reason="OOMKilled"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6442450944"
    name: ruler_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-querier
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-querier
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-querier",namespace="default",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}[5m]))
            and
            max by (pod) (up{container="ruler-querier",namespace="default",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1000"
    name: ruler_querier_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-querier",namespace="default",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"})
              and
              max by (pod) (up{container="ruler-querier",namespace="default",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-querier", namespace="default", resource="memory",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-querier", namespace="default",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-querier", namespace="default", reason="OOMKilled",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "12884901888"
    name: ruler_querier_memory_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_queries_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="ruler-query-scheduler",namespace="default",quantile="0.5",pod!~"(ruler-querier|ruler-query-scheduler)-zone.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: ruler_querier_queries_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-querier-zone-a
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-querier-zone-a
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_zone_a_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}[5m]))
            and
            max by (pod) (up{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1000"
    name: ruler_querier_zone_a_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_zone_a_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"})
              and
              max by (pod) (up{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-querier", namespace="default", resource="memory",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-querier", namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-querier", namespace="default", reason="OOMKilled",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "12884901888"
    name: ruler_querier_zone_a_memory_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_queries_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="ruler-query-scheduler",namespace="default",quantile="0.5",pod=~"(ruler-querier|ruler-query-scheduler)-zone-a.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: ruler_querier_queries_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-querier-zone-b
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-querier-zone-b
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_zone_b_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}[5m]))
            and
            max by (pod) (up{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "1000"
    name: ruler_querier_zone_b_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_zone_b_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"})
              and
              max by (pod) (up{container="ruler-querier",namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-querier", namespace="default", resource="memory",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-querier", namespace="default",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-querier", namespace="default", reason="OOMKilled",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "12884901888"
    name: ruler_querier_zone_b_memory_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_querier_queries_hpa_default
      query: sum(max_over_time(cortex_query_scheduler_inflight_requests{container="ruler-query-scheduler",namespace="default",quantile="0.5",pod=~"(ruler-querier|ruler-query-scheduler)-zone-b.*"}[1m]))
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "6"
    name: ruler_querier_queries_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-query-frontend
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-query-frontend
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-query-frontend",namespace="default",pod!~"ruler-query-frontend-zone.*"}[5m]))
            and
            max by (pod) (up{container="ruler-query-frontend",namespace="default",pod!~"ruler-query-frontend-zone.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "2000"
    name: ruler_query_frontend_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-query-frontend",namespace="default",pod!~"ruler-query-frontend-zone.*"})
              and
              max by (pod) (up{container="ruler-query-frontend",namespace="default",pod!~"ruler-query-frontend-zone.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-query-frontend", namespace="default", resource="memory",pod!~"ruler-query-frontend-zone.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-query-frontend", namespace="default",pod!~"ruler-query-frontend-zone.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-query-frontend", namespace="default", reason="OOMKilled",pod!~"ruler-query-frontend-zone.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: ruler_query_frontend_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-query-frontend-zone-a
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-query-frontend-zone-a
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_zone_a_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-a.*"}[5m]))
            and
            max by (pod) (up{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-a.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "2000"
    name: ruler_query_frontend_zone_a_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_zone_a_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-a.*"})
              and
              max by (pod) (up{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-a.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-query-frontend", namespace="default", resource="memory",pod=~"ruler-query-frontend-zone-a.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-query-frontend", namespace="default",pod=~"ruler-query-frontend-zone-a.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-query-frontend", namespace="default", reason="OOMKilled",pod=~"ruler-query-frontend-zone-a.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: ruler_query_frontend_zone_a_memory_hpa_default
    type: prometheus
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ruler-query-frontend-zone-b
  namespace: default
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          policies:
          - periodSeconds: 60
            type: Percent
            value: 10
  maxReplicaCount: 10
  minReplicaCount: 2
  pollingInterval: 10
  scaleTargetRef:
    name: ruler-query-frontend-zone-b
  triggers:
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_zone_b_cpu_hpa_default
      query: |
        max_over_time(
          sum(
            sum by (pod) (rate(container_cpu_usage_seconds_total{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-b.*"}[5m]))
            and
            max by (pod) (up{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-b.*"}) > 0
          )[15m:]
        ) * 1000
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "2000"
    name: ruler_query_frontend_zone_b_cpu_hpa_default
    type: prometheus
  - metadata:
      ignoreNullValues: "false"
      metricName: ruler_query_frontend_zone_b_memory_hpa_default
      query: |
        max_over_time(
          sum(
            (
              sum by (pod) (container_memory_working_set_bytes{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-b.*"})
              and
              max by (pod) (up{container="ruler-query-frontend",namespace="default",pod=~"ruler-query-frontend-zone-b.*"}) > 0
            ) or vector(0)
          )[15m:]
        )
        +
        sum(
          sum by (pod) (max_over_time(kube_pod_container_resource_requests{container="ruler-query-frontend", namespace="default", resource="memory",pod=~"ruler-query-frontend-zone-b.*"}[15m]))
          and
          max by (pod) (changes(kube_pod_container_status_restarts_total{container="ruler-query-frontend", namespace="default",pod=~"ruler-query-frontend-zone-b.*"}[15m]) > 0)
          and
          max by (pod) (kube_pod_container_status_last_terminated_reason{container="ruler-query-frontend", namespace="default", reason="OOMKilled",pod=~"ruler-query-frontend-zone-b.*"})
          or vector(0)
        )
      serverAddress: http://prometheus.default:9090/prometheus
      threshold: "629145600"
    name: ruler_query_frontend_zone_b_memory_hpa_default
    type: prometheus
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    grafana.com/inject-rollout-operator-ca: "true"
    grafana.com/namespace: default
  name: no-downscale-default
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: rollout-operator
      namespace: default
      path: /admission/no-downscale
      port: 443
  failurePolicy: Fail
  matchPolicy: Equivalent
  name: no-downscale-default.grafana.com
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: default
  rules:
  - apiGroups:
    - apps
    apiVersions:
    - v1
    operations:
    - UPDATE
    resources:
    - statefulsets
    - statefulsets/scale
    scope: Namespaced
  sideEffects: None
  timeoutSeconds: 10
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    grafana.com/inject-rollout-operator-ca: "true"
    grafana.com/namespace: default
  name: pod-eviction-default
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: rollout-operator
      namespace: default
      path: /admission/pod-eviction
      port: 443
  failurePolicy: Fail
  name: pod-eviction-default.grafana.com
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: default
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    resources:
    - pods/eviction
    scope: Namespaced
  sideEffects: None
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    grafana.com/inject-rollout-operator-ca: "true"
    grafana.com/namespace: default
  name: zpdb-validation-default
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: rollout-operator
      namespace: default
      path: /admission/zpdb-validation
      port: 443
  failurePolicy: Fail
  name: zpdb-validation-default.grafana.com
  namespaceSelector:
    matchLabels:
      kubernetes.io/metadata.name: default
  rules:
  - apiGroups:
    - rollout-operator.grafana.com
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - zoneawarepoddisruptionbudgets
    scope: Namespaced
  sideEffects: None
---
apiVersion: rollout-operator.grafana.com/v1
kind: ZoneAwarePodDisruptionBudget
metadata:
  labels:
    name: ingester-rollout
  name: ingester-rollout
  namespace: default
spec:
  maxUnavailable: 50
  selector:
    matchLabels:
      rollout-group: ingester
---
apiVersion: rollout-operator.grafana.com/v1
kind: ZoneAwarePodDisruptionBudget
metadata:
  labels:
    name: store-gateway-rollout
  name: store-gateway-rollout
  namespace: default
spec:
  maxUnavailable: 50
  selector:
    matchLabels:
      rollout-group: store-gateway
