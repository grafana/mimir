// SPDX-License-Identifier: AGPL-3.0-only

syntax = "proto3";

package compactorschedulerpb;

import "gogoproto/gogo.proto";

option (gogoproto.marshaler_all) = true;
option (gogoproto.unmarshaler_all) = true;

message JobKey {
  string id = 1;
  int64 epoch = 2;
}

enum JobType {
  JOB_TYPE_COMPACTION = 0;
  JOB_TYPE_PLANNING = 1;
}

message JobSpec {
  string tenant = 1;
  CompactionJob job = 2;
  JobType job_type = 3;
}

message CompactionJob {
  repeated bytes blockIds = 2;
  bool split = 3;
}

service CompactorScheduler {
  rpc LeaseJob(LeaseJobRequest) returns (LeaseJobResponse);
  rpc PlannedJobs(PlannedJobsRequest) returns (PlannedJobsResponse);
  rpc UpdatePlanJob(UpdatePlanJobRequest) returns (UpdateJobResponse);
  rpc UpdateCompactionJob(UpdateCompactionJobRequest) returns (UpdateJobResponse);
}

message LeaseJobRequest {
  string worker_id = 1;
}

message LeaseJobResponse {
  JobKey key = 1;
  JobSpec spec = 2;
}

message PlannedCompactionJob {
  string id = 1;
  CompactionJob job = 2;
}

message PlannedJobsRequest {
  JobKey key = 1;
  string tenant = 2;
  repeated PlannedCompactionJob jobs = 3;
}

message PlannedJobsResponse {}

enum UpdateType {
  UPDATE_TYPE_IN_PROGRESS = 0;
  UPDATE_TYPE_COMPLETE = 1;
  UPDATE_TYPE_REASSIGN = 2;
  UPDATE_TYPE_ABANDON = 3;
}

message UpdatePlanJobRequest {
  JobKey key = 1;
  string tenant = 2;
  UpdateType update = 3;
}

message UpdateCompactionJobRequest {
  JobKey key = 1;
  string tenant = 2;
  UpdateType update = 3;
}

message UpdateJobResponse {}

enum StoredJobStatus {
  STORED_JOB_STATUS_UNKNOWN = 0;
  STORED_JOB_STATUS_AVAILABLE = 1;
  STORED_JOB_STATUS_LEASED = 2;
  STORED_JOB_STATUS_COMPLETE = 3;
}

message StoredJobInfo {
  int64 creationTime = 1;
  StoredJobStatus status = 2;
  int64 statusTime = 3;
  int32 numLeases = 4;
  int64 epoch = 5;
}

message StoredCompactionJob {
  StoredJobInfo info = 1;
  CompactionJob job = 2;
  uint32 order = 3;
}
