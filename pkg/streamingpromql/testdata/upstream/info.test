# SPDX-License-Identifier: AGPL-3.0-only
# Provenance-includes-location: https://github.com/prometheus/prometheus/tree/main/promql/testdata/info.test
# Provenance-includes-license: Apache-2.0
# Provenance-includes-copyright: The Prometheus Authors

# NOTE: The info() function now uses resource attributes stored in TSDB
# instead of joining with info metrics. Since the promql test framework
# doesn't yet support setting up resource attributes, these tests verify
# the fallback behavior when no resource attributes are available.

load 5m
    metric{instance="a", job="1", label="value"} 0 1 2
    metric_not_matching_target_info{instance="a", job="2", label="value"} 0 1 2
    metric_with_overlapping_label{instance="a", job="1", label="value", data="base"} 0 1 2
    target_info{instance="a", job="1", data="info", another_data="another info"} 1 1 1
    build_info{instance="a", job="1", build_data="build"} 1 1 1

# When no resource attributes are available (test framework limitation),
# info() returns the original series unchanged.

# With data label filter - no resource attrs, series unchanged
eval range from 0m to 10m step 5m info(metric, {data=~".+"})

# Without second argument - no resource attrs, series unchanged
eval range from 0m to 10m step 5m info(metric)
    metric{instance="a", job="1", label="value"} 0 1 2

# Non-matching identifying labels - series unchanged
eval range from 0m to 10m step 5m info(metric_not_matching_target_info)
    metric_not_matching_target_info{instance="a", job="2", label="value"} 0 1 2

# Non-existent data label matcher (not matching empty) - no results
eval range from 0m to 10m step 5m info(metric, {non_existent=~".+"})

# With overlapping labels - series unchanged (no resource attrs)
eval range from 0m to 10m step 5m info(metric_with_overlapping_label)
    metric_with_overlapping_label{data="base", instance="a", job="1", label="value"} 0 1 2

# Filtering by a label that exists on both base metric and target_info should work.
# This is a regression test for https://github.com/prometheus/prometheus/issues/17813.
# Note: data="base" on base metric, data="info" on target_info - the filter matches target_info.
eval range from 0m to 10m step 5m info(metric_with_overlapping_label, {data="info"})
    metric_with_overlapping_label{data="base", instance="a", job="1", label="value"} 0 1 2

# Filtering by a label that exists on both base metric and target_info with regex should work.
eval range from 0m to 10m step 5m info(metric_with_overlapping_label, {data=~".+"})
    metric_with_overlapping_label{data="base", instance="a", job="1", label="value"} 0 1 2

# Filtering by a label that exists on both base metric and target_info with same value.
# The selector matches the target_info, and the join succeeds via identifying labels.
# Note: Only the instance label is considered for inclusion, but it already exists on base.
eval range from 0m to 10m step 5m info(metric_with_overlapping_label, {instance="a"})
    metric_with_overlapping_label{data="base", instance="a", job="1", label="value"} 0 1 2

# Explicit __name__="target_info" - no resource attrs, series unchanged
eval range from 0m to 10m step 5m info(metric, {__name__="target_info"})
    metric{instance="a", job="1", label="value"} 0 1 2

# __name__ doesn't match target_info - series unchanged (no enrichment)
eval range from 0m to 10m step 5m info(metric, {__name__="non_existent"})
    metric{instance="a", job="1", label="value"} 0 1 2

# __name__ doesn't match target_info with data filter - no results expected
# (because data=~".+" requires non-empty value and no resource attrs found)
eval range from 0m to 10m step 5m info(metric, {__name__="non_existent", data=~".+"})
    metric{instance="a", job="1", label="value"} 0 1 2

# __name__="build_info" - not target_info, no enrichment
eval range from 0m to 10m step 5m info(metric, {__name__="build_info"})
    metric{instance="a", job="1", label="value"} 0 1 2

# __name__ regex matching multiple info metrics - not matching target_info exactly,
# but should still try resource attrs since it could match
eval range from 0m to 10m step 5m info(metric, {__name__=~".+_info"})
    metric{instance="a", job="1", label="value", build_data="build", data="info", another_data="another info"} 0 1 2

# Info metrics themselves are ignored when it comes to enriching with info metric data labels.
eval range from 0m to 10m step 5m info(build_info, {__name__=~".+_info", another_data=~".+"})
    build_info{instance="a", job="1", build_data="build"} 1 1 1

# Info metrics themselves are ignored when it comes to enriching with info metric data labels.
eval range from 0m to 10m step 5m info(build_info, {__name__=~".+_info"})
    build_info{instance="a", job="1", build_data="build"} 1 1 1

clear

# Simple series test
load 5m
    metric{instance="a", job="1", label="value"} 0 1 2

# Basic info() call - series returned unchanged when no resource attrs
eval range from 0m to 10m step 5m info(metric)
    metric{instance="a", job="1", label="value"} 0 1 2

clear

# Series with skipped scrape
load 1m
    metric{instance="a", job="1", label="value"} 0 _ 2 3 4

# info() with gaps - series unchanged, lookback still works
eval range from 1m to 4m step 1m info(metric)
    metric{instance="a", job="1", label="value"} 0 2 3 4

# @ operator works with info
eval range from 1m to 4m step 1m info(metric @ 60)
    metric{instance="a", job="1", label="value"} 0 0 0 0

# offset operator works with info
eval range from 1m to 4m step 1m info(metric offset 1m)
    metric{instance="a", job="1", label="value"} 0 0 2 3
